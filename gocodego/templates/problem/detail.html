{% extends 'base.html' %}

{% block pagetitle %} GoCodeGo - {{ problem.title }} {% endblock %}

{% block problemsactive %} class="active" {% endblock %}

{% block head %} 
<script type="text/javascript">
$(document).ready(function() {
   {% if not solved %}
   		$("#twit").hide();
   {% endif %}
   
   $("#ret").hide();
   $("#subm").click(function(event){
   		event.preventDefault();
        $.ajax({
             type:"POST",
             url:"/problems/check_solution/",
             data: {
             		'problem': {{ problem.id }},
                    'code': ace.edit("editor").getSession().getValue(),
                    },
             success: function(message){
             	console.log(message);
             	if(message == "") {
             		$('#mess').hide().html("<pre>Correct!</pre>").fadeIn();
             		$('#subm').hide();
             		$('#ret').fadeIn();
             		$('#twit').fadeIn();
             	}
                else {
                	$('#mess').hide().html("<pre>" + message + "</pre>").fadeIn();
                }
            },
            "beforeSend": function(xhr, settings) {
		        $.ajaxSettings.beforeSend(xhr, settings);
		    },
        });
   });
});

function getCookie(name) {
    var cookieValue = null;
    if (document.cookie && document.cookie != '') {
        var cookies = document.cookie.split(';');
        for (var i = 0; i < cookies.length; i++) {
            var cookie = jQuery.trim(cookies[i]);
            // Does this cookie string begin with the name we want?
            if (cookie.substring(0, name.length + 1) == (name + '=')) {
                cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                break;
            }
        }
    }
    return cookieValue;
}

$.ajaxSetup({
    beforeSend: function(xhr, settings) {
        if (!(/^http:.*/.test(settings.url) || /^https:.*/.test(settings.url))) {
            // Only send the token to relative URLs i.e. locally.
            xhr.setRequestHeader("X-CSRFToken", getCookie('csrftoken'));
        }
    }
});
</script>
{% endblock %}

{% block primary %}
<section class="success">
    <div class="container">
		<div class="col-md-6 column">
				<h1>{{ problem.title }}</h1><h5>Category: {{ problem.category }}</h5>
				<div class="jumbotron">
					{{ problem.description|linebreaksbr }}
				</div>
				<h1>Messages</h1>
				<div class="jumbotron" id="mess">
				</div>
				<div id="twit">
					<a href="https://twitter.com/share" class="twitter-share-button" data-url=" " data-text="I have solved '{{problem.title}}'!" data-via="GoCodeGo" data-size="large" data-related="GoCodeGo" data-count="none" id="twit">Tweet</a> <script>!function(d,s,id){var js,fjs=d.getElementsByTagName(s)[0],p=/^http:/.test(d.location)?'http':'https';if(!d.getElementById(id)){js=d.createElement(s);js.id=id;js.src=p+'://platform.twitter.com/widgets.js';fjs.parentNode.insertBefore(js,fjs);}}(document, 'script', 'twitter-wjs');</script>
				</div>
			</div>
			<div class="col-md-6 column">
				<h1>Start coding here!</h1>
				{% if solved %}
					<div id="editor">{{ solution }}</div>
				{% else %}
					<div id="editor">{{ problem.template }}</div>
				{% endif %}
				<div><br /></div>
				<div align="right">
			        {% if user.is_authenticated %}
				        {% if solved %}
				        	<a class="btn btn-primary" href="#" role="button">Solved!</a>
				        {% else %}
				        	<a class="btn btn-primary" href="#" id="subm">Submit!</a>
				        	<a class="btn btn-primary" href="/problems/" id="ret">Return to problems</a>
				        {% endif %}
				    {% else %}
				    	<a class="btn btn-primary" href="{% url 'socialauth_begin' 'google-oauth2' %}">Login with Google</a>
			        {% endif %}
				</div>
			</div>
		</div>
	</div>
</section>


{% load staticfiles %}
<script src="{% static "js/ace/ace.js" %}" type="text/javascript"></script>
<script>
	var editor = ace.edit("editor");
    editor.setTheme("ace/theme/clouds");
    editor.getSession().setMode("ace/mode/golang");
</script>

{% endblock %}